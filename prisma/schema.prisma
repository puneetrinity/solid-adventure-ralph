generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workflow {
  id         String   @id @default(uuid())
  state      String
  title      String?

  // Goal and context for LLM
  goal       String?  // Plain English request or ticket text (required in UI)
  context    String?  // Extra info, links, acceptance criteria
  feedback   String?  // Latest feedback from Request Changes

  // Legacy single-repo fields (deprecated, use WorkflowRepo)
  repoOwner  String?
  repoName   String?
  baseBranch String   @default("main")
  baseSha    String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  repos            WorkflowRepo[]
  events           WorkflowEvent[]
  artifacts        Artifact[]
  approvals        Approval[]
  patchSets        PatchSet[]
  pullRequests     PullRequest[]
  runs             WorkflowRun[]
  policyViolations PolicyViolation[]
  checkpoints      Checkpoint[]
}

model WorkflowRepo {
  id         String   @id @default(uuid())
  workflowId String
  owner      String
  repo       String
  baseBranch String   @default("main")
  baseSha    String?
  role       String   @default("primary") // primary | secondary
  createdAt  DateTime @default(now())

  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, owner, repo])
  @@index([workflowId])
  @@index([owner, repo])
}

model GitHubAuth {
  githubUserId String   @id
  username     String
  accessToken  String
  tokenType    String?
  scope        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([username])
}

model RepoContext {
  id          String   @id @default(uuid())
  repoOwner   String
  repoName    String
  baseBranch  String   @default("main")
  baseSha     String?  // SHA when context was fetched
  contextPath String   @default("PROJECT_CONTEXT.md") // or AGENTS.md
  content     String?  // Full content of the context file
  summary     String?  // LLM-generated summary
  isStale     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([repoOwner, repoName, baseBranch])
  @@index([repoOwner, repoName])
}

model WorkflowEvent {
  id         String   @id @default(uuid())
  workflowId String
  type       String
  payload    Json
  createdAt  DateTime @default(now())

  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, createdAt])
}

model Artifact {
  id         String   @id @default(uuid())
  workflowId String
  kind       String
  path       String?
  content    String
  contentSha String
  createdAt  DateTime @default(now())

  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, kind, createdAt])
}

model Approval {
  id         String   @id @default(uuid())
  workflowId String
  kind       String   // e.g. "apply_patches"
  createdAt  DateTime @default(now())

  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, kind])
}

model PatchSet {
  id         String   @id @default(uuid())
  workflowId String
  title      String
  baseSha    String
  status     String   // proposed | approved | rejected | applied
  createdAt  DateTime @default(now())
  approvedAt DateTime?
  approvedBy String?

  // Multi-repo support: optional repo scope
  repoOwner  String?
  repoName   String?

  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  patches    Patch[]
  policyViolations PolicyViolation[]

  @@index([workflowId, createdAt])
  @@index([workflowId, status])
  @@index([repoOwner, repoName])
}

model Patch {
  id          String   @id @default(uuid())
  patchSetId  String
  taskId      String?
  title       String
  summary     String
  diff        String
  files       Json     // array of {path, additions, deletions}
  addsTests   Boolean
  riskLevel   String   // low | med | high
  proposedCommands Json // array of strings
  createdAt   DateTime @default(now())

  // Multi-repo support: which repo this patch applies to
  repoOwner   String?
  repoName    String?

  patchSet    PatchSet @relation(fields: [patchSetId], references: [id], onDelete: Cascade)

  @@index([patchSetId, createdAt])
  @@index([repoOwner, repoName])
}

model PullRequest {
  id         String   @id @default(uuid())
  workflowId String
  number     Int
  url        String
  branch     String
  status     String   // open|merged|closed
  createdAt  DateTime @default(now())

  // Multi-repo support: which repo this PR belongs to
  repoOwner  String?
  repoName   String?

  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, createdAt])
  @@index([repoOwner, repoName])
  @@index([number])
}

model WorkflowRun {
  id          String   @id @default(uuid())
  workflowId  String
  jobName     String   // e.g. "ingest_context", "apply_patches", "orchestrate"
  status      String   // pending | running | completed | failed
  inputHash   String   // SHA256 of canonical JSON inputs
  inputs      Json     // raw input data for audit
  outputs     Json?    // result data (nullable for pending/failed)
  errorMsg    String?  // error message if failed
  startedAt   DateTime @default(now())
  completedAt DateTime?
  durationMs  Int?     // computed: completedAt - startedAt

  // Token usage tracking (T8.2)
  inputTokens   Int?    // tokens sent to LLM
  outputTokens  Int?    // tokens received from LLM
  totalTokens   Int?    // inputTokens + outputTokens
  estimatedCost Int?    // cost in cents (USD)
  agentRole     String? // architect | coder | reviewer | tester | diagnoser | documenter
  promptVersion String? // version of prompt used
  memoryTier    String? // HOT | WARM | COLD context used

  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, jobName, startedAt])
  @@index([inputHash])
  @@index([workflowId, agentRole])
}

model PolicyViolation {
  id          String   @id @default(uuid())
  workflowId  String
  patchSetId  String?  // optional - violations can be at workflow or patchset level
  rule        String   // frozen_file | deny_glob | secret_detected | dependency_change
  severity    String   // WARN | BLOCK
  file        String   // file path that triggered the violation
  message     String   // human-readable description
  line        Int?     // optional line number
  evidence    String?  // optional snippet/pattern that matched
  createdAt   DateTime @default(now())

  // Multi-repo support
  repoOwner   String?
  repoName    String?

  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  patchSet    PatchSet? @relation(fields: [patchSetId], references: [id], onDelete: Cascade)

  @@index([workflowId, createdAt])
  @@index([workflowId, severity])
  @@index([patchSetId])
  @@index([repoOwner, repoName])
}

model GitHubWebhook {
  id          String   @id @default(uuid())
  deliveryId  String   @unique // X-GitHub-Delivery header
  eventType   String   // push | pull_request | check_suite | workflow_run | etc
  action      String?  // action field from payload (opened, closed, completed, etc)
  repoOwner   String   // repository owner
  repoName    String   // repository name
  headSha     String?  // commit SHA if applicable
  payload     Json     // full webhook payload
  signature   String   // X-Hub-Signature-256 header value
  processed   Boolean  @default(false) // whether this event has been processed
  processedAt DateTime? // when the event was processed
  createdAt   DateTime @default(now())

  @@index([eventType, action])
  @@index([repoOwner, repoName])
  @@index([headSha])
  @@index([processed, createdAt])
}

model Checkpoint {
  id          String   @id @default(uuid())
  workflowId  String
  name        String   // descriptive name for the checkpoint
  state       String   // workflow state at checkpoint
  stageIndex  Int      // which stage (0, 1, 2, ...) in the workflow
  stageName   String   // human-readable stage name
  snapshot    Json     // full state snapshot (artifacts, patchsets, approvals, etc.)
  metadata    Json?    // optional metadata (reason, trigger, etc.)
  isAutomatic Boolean  @default(true)  // auto vs manual checkpoint
  createdAt   DateTime @default(now())
  createdBy   String?  // user who created (if manual)

  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, createdAt])
  @@index([workflowId, stageIndex])
}
